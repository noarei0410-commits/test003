/**
 * Arts Manager
 * Centralizes logic for Arts activation, cost checking, and visual feedback.
 */
class ArtsManager {
    constructor() {
        this.activeButtons = new Map(); // Stores state for generated buttons: id -> { cardData, skill, stackCards }
        this.overlayElement = null;
    }

    /**
     * Initialize or reset the manager (e.g., when closing zoom)
     */
    reset() {
        this.activeButtons.clear();
    }

    /**
     * Register a potential Art activation to get a unique ID for the button
     * @param {Object} cardData 
     * @param {Object} skill 
     * @param {Array} stackCards 
     * @returns {string} Unique ID for onclick handler
     */
    register(cardData, skill, stackCards) {
        const id = `art_btn_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
        this.activeButtons.set(id, { cardData, skill, stackCards });
        return id;
    }

    /**
     * Check if an art can be activated based on costs
     * @param {Object} skill 
     * @param {Array} stackCards 
     * @returns {boolean}
     */
    canActivate(skill, stackCards) {
        if (!skill.cost) return true; // No cost = always active
        // Delegate to utils function if available, otherwise implement logic here
        if (typeof checkCostSatisfied === 'function') {
            return checkCostSatisfied(skill.cost, stackCards);
        }
        console.warn("checkCostSatisfied not found in utils.js");
        return false;
    }

    /**
     * Handle the click event from the UI
     * @param {string} id - The ID generated by register()
     */
    handleActivate(id) {
        const data = this.activeButtons.get(id);
        if (!data) {
            console.error("ArtsManager: Activation data not found for ID:", id);
            return;
        }

        const { cardData, skill } = data;
        console.log(`[ArtsManager] Activating: ${skill.name} from ${cardData.id}`);

        this.showActivationOverlay(cardData, skill);

        // Optional: Send to server
        // if (window.socket) window.socket.emit('activateArt', { ... });

        // Close Zoom after delay
        setTimeout(() => {
            const zoomModal = document.getElementById('zoom-modal');
            if (zoomModal) zoomModal.style.display = 'none';
        }, 300);
    }

    /**
     * Show the visual overlay for activation
     * @param {Object} cardData 
     * @param {Object} skill 
     */
    showActivationOverlay(cardData, skill) {
        // Remove existing if any
        if (this.overlayElement) this.overlayElement.remove();

        const overlay = document.createElement('div');
        overlay.className = 'arts-activation-overlay';
        overlay.innerHTML = `
            <div class="arts-activation-card">
                <div class="arts-activation-header">
                    <span class="arts-label">ARTS</span>
                    <span class="arts-name">${skill.name}</span>
                </div>
                ${skill.damage ? `
                    <div class="arts-damage-display">
                        <span class="damage-value">${skill.damage}</span>
                        <span class="damage-label">DAMAGE</span>
                    </div>
                ` : ''}
                ${skill.text && skill.text !== 'なし' ? `
                    <div class="arts-effect-text">${skill.text}</div>
                ` : ''}
                <div class="arts-activation-footer">
                    <button class="btn-arts-confirm" id="btn-arts-confirm-close">確認</button>
                </div>
            </div>
        `;

        document.body.appendChild(overlay);
        this.overlayElement = overlay;

        // Event for close button
        const closeBtn = overlay.querySelector('#btn-arts-confirm-close');
        closeBtn.onclick = () => this.closeOverlay();

        // Animate in
        requestAnimationFrame(() => {
            overlay.classList.add('active');
        });
    }

    closeOverlay() {
        if (this.overlayElement) {
            this.overlayElement.classList.remove('active');
            setTimeout(() => {
                if (this.overlayElement) this.overlayElement.remove();
                this.overlayElement = null;
            }, 300);
        }
    }
}

// Instantiate globally
window.artsManager = new ArtsManager();

// Global helper for onclick (bridge)
window.activateArtById = (id) => {
    window.artsManager.handleActivate(id);
};
